<!DOCTYPE html>
<html lang="ko" xml:lang="ko">
<head>
    <meta http-equiv="Content-Type" content="text/html" charset="UTF-8">
    <link rel="stylesheet" href="style.css">
    <title>EDITOR EXAM</title>
</head>
<body onload="autoFocus()">
    <section class="main_section">
        <div class="title_bar">
            <h1>EDITOR EXAM</h1>
        </div>
        <div class="editor_body">
            <div id="btn_area_top" class="btn_area_top toolbar" >
                <table>
                    <tbody>
                        <tr>
                            <td>
                                <button id="testBtn">테스트</button>
                                <button id="uploadForm">업로드</button>
                                <button id="new_btn" type="button" onclick="newPage()">
                                    <span>새 문서</span>
                                </button>
                                <button id="undo_btn" type="button" onclick="setStyle('undo', null)">
                                    <span>되돌리기</span>
                                </button>
                                <button id="redo_btn" type="button" onclick="setStyle('redo', null)">
                                    <span>다시실행</span>
                                </button>
                                <select id='font_type'>
                                    <option value="">글꼴</option>
                                    <option value="바탕">바탕</option>
                                    <option value="돋움">돋움</option>
                                    <option value="굴림">굴림</option>
                                    <option value="궁서">궁서</option>
                                    <option value="맑은 고딕">맑은 고딕</option>
                                </select>
                                <select id='font_size'>
                                    <option value="">글자 크기</option>
                                    <option value="1">4px</option>
                                    <option value="2">8px</option>
                                    <option value="3">10px</option>
                                    <option value="4">12px</option>
                                    <option value="5">16px</option>
                                    <option value="6">20px</option>
                                    <option value="7">30px</option>
                                </select>
                                <select id='font_color'>
                                    <option value="">색상</option>
                                    <option value="black">Black</option>
                                    <option value="red">Red</option>
                                    <option value="green">Green</option>
                                    <option value="blue">Blue</option>
                                    <option value="gray">Gray</option>
                                    <option value="white">White</option>
                                    <option value="yellow">Yellow</option>
                                </select>
                                <button id="bold_btn" type="button" onclick="setStyle('bold', null)">
                                    <span>굵게</span>
                                </button>
                                <button id="italic_btn" type="button" onclick="setStyle('italic', null)">
                                    <span>이탤릭체</span>
                                </button>
                                <button id="underline_btn" type="button" onclick="setStyle('underline', null)">
                                    <span>밑줄</span>
                                </button>
                                <label id="uploadBtnLabel" for="uploadBtn">이미지</label>
                                <input id="uploadBtn" type="file" onchange="imageUpload(event);" multiple style="display: none;">
                                <button id="justifyLeft_btn" type="button" onclick="setStyle('justifyLeft', null)">
                                    <span>왼쪽 정렬</span>
                                </button>
                                <button id="justifyCenter_btn" type="button" onclick="setStyle('justifyCenter', null)">
                                    <span>가운데 정렬</span>
                                </button>
                                <button id="justifyRight_btn" type="button" onclick="setStyle('justifyRight', null)">
                                    <span>오른쪽 정렬</span>
                                </button>
                                <button id="insertOrderedList_btn" type="button" onclick="setStyle('insertOrderedList', null)">
                                    <span>글머리 번호</span>
                                </button>
                                <button id="insertUnorderedList_btn" type="button" onclick="setStyle('insertUnorderedList', null)">
                                    <span>글머리 기호</span>
                                </button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div id="text_area" class="text_area">
                <iframe id="edit_frame" class="edit_frame" src="editArea.html" frameborder="0"></iframe>
            </div>
            <div id="btn_area_bottom" class="btn_area_bottom">
                <button type="button" onclick="showPreview()">
                    <span>미리보기</span>
                </button>
            </div>
        </div>
    </section>
    <script lang="text/javascript">
        //iframe window 가져오기
        const editWindow = document.getElementById('edit_frame').contentWindow;
        
        //autoFocus 기능
        function autoFocus(){
            editWindow.document.getElementById('edit_area').focus();
        }

        // caret 저장
        let selection; //selection, range 도입
        let range;  //range : 현재 커서가 위치한 node 정보와 위치 index 값이 저장되어 있음
        document.getElementById('uploadBtnLabel').addEventListener('mouseover', function(e){
            selection = editWindow.document.getSelection();
            range = selection.getRangeAt(0);
        })

        // p태그 자동 생성
        editWindow.addEventListener('keyup', function(e){
            const editArea = editWindow.document.getElementById('edit_area')
            if(editArea.lastElementChild == null){
                const pTag = editWindow.document.createElement('p')
                editArea.appendChild(pTag)
                const brTag = editWindow.document.createElement('br')
                editArea.getElementsByTagName('p')[0].appendChild(brTag)
            }
        })

        //새 문서 기능
        function newPage(){
            const answer = confirm('작성중인 문서가 삭제됩니다. 계속하시겠습니까?');
            if(answer){
                setStyle('selectAll', null);
                setStyle('removeFormat', null);
                setStyle('delete', null);
                autoFocus();
            }
        }

        //select 버튼
        const btnFontType = document.getElementById('font_type');
        const btnFontSize = document.getElementById('font_size');
        const btnFontColor = document.getElementById('font_color');

        //select 버튼별 이벤트 적용
        btnFontType.addEventListener('change', function (e) {
            setStyle('fontName', e.target.value)
        })
        btnFontSize.addEventListener('change', function (e) {
            setStyle('fontSize', e.target.value)
        })
        btnFontColor.addEventListener('change', function (e) {
            setStyle('foreColor', e.target.value)
        })

        //버튼별 서식 적용
        function setStyle(style, value){
            if(value != null){
                editWindow.document.execCommand(style, false, value);
            }
            else{
                editWindow.document.execCommand(style);
            }
            autoFocus()  //서식 적용 후에도 커서 위치 유지하도록 적용
        }

        // 미리보기 창
        function showPreview(){
            // 현재 document 내 iframe에 입력된 HTML 가져오기
            const editedContent = editWindow.document.getElementById('edit_area').innerHTML;

            // 팝업옵션 설정
            const options = 'top=100, left=500, width=800, height=800';
            const preview = window.open('about:blank', 'preview', options);

            // 팝업창에 HTML내용 넣기
            preview.document.write(editedContent);
            preview.document.close();
        }

        // 이미지 삽입
        function imageUpload(event) {
            // 이미지 삽입 위치(21.06.29 selection, range 도입으로 삭제)
            //const uploadWrap = editArea.document.getElementById('edit_area'); 
            
            // 다중 이미지 파일 업로드
            // for(let images of event.target.files){   //IE상에서 에러 발생 -> IE에서는 for(...of...) 반복문 지원을 안함
            for(let i = 0; i < event.target.files.length; i++){     //IE 호환을 위해 로직 변경
                const images = event.target.files[i]
                // 파일을 읽을 수 있는 File Reader 객체를 생성
                const reader = new FileReader();
                const newImg = editWindow.document.createElement("img");

                // 파일이 읽혀지면 아래 함수가 실행
                reader.onload = function(event) {
                    // 문서내에 새 img 태그를 생성, 원하는 위치의 자식으로 img태그를 삽입(21.06.29 selection, range 도입으로 삭제)      
                    //uploadWrap.appendChild(newImg);

                    // img 태그의 속성 설정
                    newImg.src = 'http://127.0.0.1:8085/download/테스트이미지.jpg'
                    // event.target.result; // = newImg.setAttribute("src", event.target.result);        // input에 업로드 된 file의 정보를 통해 src정보 입력
                    const newImgWidth = prompt('가로 길이를 입력해 주세요.(단위: px)');
                    newImg.width = newImgWidth;
                    
                    // img 태그의 속성 설정 완료 후 커서 위치에 img node 삽입
                    range.insertNode(newImg);
                }; 

                reader.readAsDataURL(images);
            }

            // IE상에서 focus 위치를 잡지 못해 다시 focus를 잡아주어야 함
            autoFocus()
            selection = editWindow.document.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
        }

        document.getElementById("uploadForm").addEventListener("click", ()=>{
            // 팝업옵션 설정
            const options = 'top=100, left=500, width=300, height=300';
            const preview = window.open('uploadForm.html', 'preview', options);
        })

        // id가 test인 요소에 클릭 이벤틀르 추가한다.
        document.getElementById("testBtn").addEventListener("click", ()=>{
        // ajax를 하기 위한 XmlHttpRequest 객체
        let xhttp = new XMLHttpRequest();
        // XmlHttpRequest의 요청
        xhttp.onreadystatechange = (e)=>{
            // XMLHttpRequest를 이벤트 파라미터에서 취득
            let req = e.target;
            // 콘솔 출력
            console.log(req);
            // 통신 상태가 완료가 되면.
            if(req.readyState === XMLHttpRequest.DONE) {
                // Http response 응답코드가 200(정상)이면
                if(req.status === 200) {
                    // response 결과를 콘솔에 출력
                    console.log(req.response);
                    // json 타입이므로 object 형식으로 변환
                    console.log(JSON.parse(req.responseText));
                }
            }
        }
        // http 요청 타입과 주소, 동기식 여부
        xhttp.open("GET", "http://127.0.0.1:8085/download/테스트이미지.jpg", true);
        // xml 형식을 받을 경우
        //xhttp.overrideMimeType('text/xml');
        // http 요청
        xhttp.send();
        });


    </script>
</body>
</html>